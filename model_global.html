<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>model_global.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="analytics.html">analytics.rb</a>
          <a class="source" href="document_store.html">document_store.rb</a>
          <a class="source" href="error_codes.html">error_codes.rb</a>
          <a class="source" href="model_global.html">model_global.rb</a>
          <a class="source" href="model_validations.html">model_validations.rb</a>
          <a class="source" href="radlib_fillin.html">radlib_fillin.rb</a>
          <a class="source" href="radlib_fillin_collection.html">radlib_fillin_collection.rb</a>
          <a class="source" href="radlib_story.html">radlib_story.rb</a>
          <a class="source" href="radlib_text_array.html">radlib_text_array.rb</a>
          <a class="source" href="radlibs_base.html">radlibs_base.rb</a>
          <a class="source" href="user.html">user.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>model_global.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>Author:: Couchbase <a href="mailto:info@couchbase.com">info@couchbase.com</a>
Copyright:: 2012 Couchbase, Inc.
License:: Apache License, Version 2.0</p>

<p>Licensed under the Apache License, Version 2.0 (the &ldquo;License&rdquo;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &ldquo;AS IS&rdquo; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">ModelGlobal</span>
  <span class="kp">include</span> <span class="no">DocumentStore</span>


  <span class="k">def</span> <span class="nf">get_new_radlib_id</span>
    <span class="no">ModelGlobal</span><span class="o">.</span><span class="n">get_new_radlib_id</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>returns the number of radlibs created so far</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">num_radlibs</span>
    <span class="no">ModelGlobal</span><span class="o">.</span><span class="n">num_radlibs</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">find_radlib_by_radlib_id</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">,</span> <span class="n">get_radlib_object</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span>
    <span class="no">ModelGlobal</span><span class="o">.</span><span class="n">find_radlib_by_radlib_id</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">,</span> <span class="n">get_radlib_object</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_multiple_radlibs_by_radlib_id</span><span class="p">(</span><span class="n">radlib_ids</span><span class="p">,</span> <span class="n">get_radlib_objects</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span>
    <span class="no">ModelGlobal</span><span class="o">.</span><span class="n">get_multiple_radlibs_by_radlib_id</span><span class="p">(</span><span class="n">radlib_ids</span><span class="p">,</span> <span class="n">get_radlib_objects</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_new_uid</span>
    <span class="no">ModelGlobal</span><span class="o">.</span><span class="n">get_new_uid</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>returns nil if the user isn&rsquo;t found, by default it returns a user object, set get<em>user</em>object to false if you just want the uid</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">find_user_by_facebook_id</span><span class="p">(</span><span class="n">facebook_id</span><span class="p">,</span> <span class="n">get_user_object</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span>
    <span class="no">ModelGlobal</span><span class="o">.</span><span class="n">find_user_by_facebook_id</span><span class="p">(</span><span class="n">facebook_id</span><span class="p">,</span> <span class="n">get_user_object</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>returns nil if the user isn&rsquo;t found, by default it returns a user object, set get<em>user</em>object to false if you just want the uid</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">find_user_by_uid</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">get_user_object</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span>
    <span class="no">ModelGlobal</span><span class="o">.</span><span class="n">find_user_by_uid</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">get_user_object</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_multiple_users_by_uid</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="n">get_user_objects</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span>
    <span class="no">ModelGlobal</span><span class="o">.</span><span class="n">get_multiple_users_by_uid</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="n">get_user_objects</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>returns nil if the user isn&rsquo;t found, by default it returns a user object, set get<em>user</em>object to false if you just want the uid</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">find_user_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">get_user_object</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span>
    <span class="no">ModelGlobal</span><span class="o">.</span><span class="n">find_user_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">get_user_object</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>returns the number of users signed up</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">num_users</span>
    <span class="no">ModelGlobal</span><span class="o">.</span><span class="n">num_users</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">add_super_user</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
    <span class="no">ModelGlobal</span><span class="o">.</span><span class="n">add_super_user</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">remove_super_user</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
    <span class="no">ModelGlobal</span><span class="o">.</span><span class="n">remove_super_user</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>returns the number of users signed up</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">num_superusers</span>
    <span class="no">ModelGlobal</span><span class="o">.</span><span class="n">num_superusers</span>
  <span class="k">end</span>


  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="kp">include</span> <span class="no">DocumentStore</span>

    <span class="k">def</span> <span class="nf">find_radlib_by_radlib_id</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">,</span> <span class="n">get_radlib_object</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>make sure it&rsquo;s a string&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">radlib_id</span> <span class="o">=</span> <span class="n">radlib_id</span><span class="o">.</span><span class="n">to_s</span>

      <span class="k">if</span> <span class="n">get_radlib_object</span>
        <span class="n">radlib</span> <span class="o">=</span> <span class="kp">nil</span>
        <span class="n">radlib</span> <span class="o">=</span> <span class="no">RadlibStory</span><span class="o">.</span><span class="n">new</span> <span class="p">({</span><span class="ss">:retrieve</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:radlib_id</span> <span class="o">=&gt;</span> <span class="n">radlib_id</span> <span class="p">})</span> <span class="k">if</span> <span class="n">document_exists?</span><span class="p">(</span><span class="s2">&quot;rad::</span><span class="si">#{</span><span class="n">radlib_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">radlib</span>
      <span class="k">else</span>
        <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;rad::</span><span class="si">#{</span><span class="n">radlib_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">get_multiple_radlibs_by_radlib_id</span><span class="p">(</span><span class="n">radlib_ids</span><span class="p">,</span> <span class="n">get_radlib_objects</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span>
      <span class="n">radlib_ids</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
        <span class="n">radlib_ids</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;rad::</span><span class="si">#{</span><span class="n">r</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;get_multiple_radlibs_by_radlib_id requires that all radlib_id&#39;s in array are non-nil&quot;</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">nil?</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">get_radlib_objects</span>
        <span class="n">radlib_docs</span> <span class="o">=</span> <span class="n">get_documents</span><span class="p">(</span><span class="n">radlib_ids</span><span class="p">)</span>
        <span class="n">radlibs</span> <span class="o">=</span> <span class="o">[]</span>
        <span class="n">radlib_docs</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">doc</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
          <span class="n">radlibs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="no">RadlibStory</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span> <span class="n">radlib_docs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="p">)</span> <span class="k">if</span> <span class="n">radlib_docs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span>
        <span class="k">end</span>
        <span class="n">radlibs</span>
      <span class="k">else</span>
        <span class="n">get_documents</span><span class="p">(</span><span class="n">radlib_ids</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>returns nil if the user isn&rsquo;t found, by default it returns a user object, set get<em>user</em>object to false if you just want the uid</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">find_user_by_facebook_id</span><span class="p">(</span><span class="n">facebook_id</span><span class="p">,</span> <span class="n">get_user_object</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>make sure it&rsquo;s a string&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">facebook_id</span> <span class="o">=</span> <span class="n">facebook_id</span><span class="o">.</span><span class="n">to_s</span>

      <span class="k">if</span> <span class="n">get_user_object</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;fb::</span><span class="si">#{</span><span class="n">facebook_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="kp">nil</span>
        <span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="p">({</span> <span class="ss">:retrieve</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="n">uid</span> <span class="p">})</span> <span class="k">if</span> <span class="n">uid</span>
        <span class="n">u</span>
      <span class="k">else</span>
        <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;fb::</span><span class="si">#{</span><span class="n">facebook_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>returns nil if the user isn&rsquo;t found, by default it returns a user object, set get<em>user</em>object to false if you just want the uid</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">find_user_by_uid</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">get_user_object</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>make sure it&rsquo;s a string&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span><span class="o">.</span><span class="n">to_s</span>

      <span class="k">if</span> <span class="n">get_user_object</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="p">({</span> <span class="ss">:retrieve</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="n">uid</span> <span class="p">})</span> <span class="k">if</span> <span class="n">u</span>
        <span class="n">u</span>
      <span class="k">else</span>
        <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">get_multiple_users_by_uid</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="n">get_user_objects</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span>
      <span class="n">uids</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
        <span class="n">uids</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">u</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;get_multiple_users_by_uid requires that all uid&#39;s in array are non-nil&quot;</span> <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">nil?</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">get_user_objects</span>
        <span class="n">uid_docs</span> <span class="o">=</span> <span class="n">get_documents</span><span class="p">(</span><span class="n">uids</span><span class="p">)</span>
        <span class="n">users</span> <span class="o">=</span> <span class="o">[]</span>
        <span class="n">uid_docs</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">doc</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
          <span class="n">users</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span> <span class="n">uid_docs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="p">)</span> <span class="k">if</span> <span class="n">uid_docs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span>
        <span class="k">end</span>
        <span class="n">users</span>
      <span class="k">else</span>
        <span class="n">get_documents</span><span class="p">(</span><span class="n">uids</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>returns nil if the user isn&rsquo;t found, by default it returns a user object, set get<em>user</em>object to false if you just want the uid</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">find_user_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">get_user_object</span> <span class="o">=</span> <span class="kp">true</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">get_user_object</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;email::</span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="kp">nil</span>
        <span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="p">({</span> <span class="ss">:retrieve</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="n">uid</span> <span class="p">})</span> <span class="k">if</span> <span class="n">uid</span>
        <span class="n">u</span>
      <span class="k">else</span>
        <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;email::</span><span class="si">#{</span><span class="n">facebook_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>returns the number of users signed up</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">num_users</span>
      <span class="no">Analytics</span><span class="o">.</span><span class="n">num_users</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>returns a new uid for creating/saving a new user</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">get_new_uid</span>
      <span class="no">Analytics</span><span class="o">.</span><span class="n">increment_num_users</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>returns the number of radlibs created so far</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">num_radlibs</span>
      <span class="no">Analytics</span><span class="o">.</span><span class="n">num_radlibs</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>returns a new radlib_id</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">get_new_radlib_id</span>
      <span class="no">Analytics</span><span class="o">.</span><span class="n">increment_num_radlibs</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">add_super_user</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Make sure the user counter is set in Couchbase</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">initialize_document</span><span class="p">(</span><span class="s2">&quot;superusers::count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Create the Super Users list-array</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">initialize_document</span><span class="p">(</span><span class="s2">&quot;superusers&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:users</span> <span class="o">=&gt;</span> <span class="o">[]</span> <span class="p">})</span>

      <span class="n">doc</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;superusers&quot;</span><span class="p">)</span>
      <span class="n">users</span> <span class="o">=</span> <span class="n">doc</span><span class="o">[</span><span class="ss">:users</span><span class="o">]</span>
      <span class="k">unless</span> <span class="n">users</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="n">users</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

        <span class="n">doc</span><span class="o">[</span><span class="ss">:users</span><span class="o">]</span> <span class="o">=</span> <span class="n">users</span>

        <span class="n">replace_document</span><span class="p">(</span><span class="s2">&quot;superusers&quot;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
        <span class="n">increase_atomic_count</span><span class="p">(</span><span class="s2">&quot;superusers::count&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">remove_super_user</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Make sure the user counter is set in Couchbase</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">initialize_document</span><span class="p">(</span><span class="s2">&quot;superusers::count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Create the Super Users list-array</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">initialize_document</span><span class="p">(</span><span class="s2">&quot;superusers&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:users</span> <span class="o">=&gt;</span> <span class="o">[]</span> <span class="p">})</span>

      <span class="n">doc</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;superusers&quot;</span><span class="p">)</span>
      <span class="n">users</span> <span class="o">=</span> <span class="n">doc</span><span class="o">[</span><span class="ss">:users</span><span class="o">]</span>
      <span class="n">users</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
      <span class="n">doc</span><span class="o">[</span><span class="ss">:users</span><span class="o">]</span> <span class="o">=</span> <span class="n">users</span>

      <span class="n">replace_document</span><span class="p">(</span><span class="s2">&quot;superusers&quot;</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
      <span class="n">decrease_atomic_count</span><span class="p">(</span><span class="s2">&quot;superusers::count&quot;</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>returns the number of users signed up</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">num_superusers</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>retrieve the current user count</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">count</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;superusers::count&quot;</span><span class="p">)</span>

      <span class="k">return</span> <span class="mi">0</span> <span class="k">unless</span> <span class="n">count</span>
      <span class="k">return</span> <span class="n">count</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">get_super_users</span>
      <span class="n">doc</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;superusers&quot;</span><span class="p">)</span>
      <span class="n">users</span> <span class="o">=</span> <span class="n">doc</span><span class="o">[</span><span class="ss">:users</span><span class="o">]</span>

      <span class="n">superusers</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">uid</span><span class="o">|</span>
        <span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="p">({</span> <span class="ss">:retrieve</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="n">uid</span> <span class="p">})</span>
        <span class="n">superusers</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="n">superusers</span>
    <span class="k">end</span>
  <span class="k">end</span> <span class="c1"># end ClassMethods</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
