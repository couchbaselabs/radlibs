<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>user.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="analytics.html">analytics.rb</a>
          <a class="source" href="document_store.html">document_store.rb</a>
          <a class="source" href="error_codes.html">error_codes.rb</a>
          <a class="source" href="model_global.html">model_global.rb</a>
          <a class="source" href="model_validations.html">model_validations.rb</a>
          <a class="source" href="radlib_fillin.html">radlib_fillin.rb</a>
          <a class="source" href="radlib_fillin_collection.html">radlib_fillin_collection.rb</a>
          <a class="source" href="radlib_story.html">radlib_story.rb</a>
          <a class="source" href="radlib_text_array.html">radlib_text_array.rb</a>
          <a class="source" href="radlibs_base.html">radlibs_base.rb</a>
          <a class="source" href="user.html">user.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>user.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-The_User_class_contains_all_the_actions_that_users_take_on_the_system,_very_User_centric'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-The_User_class_contains_all_the_actions_that_users_take_on_the_system,_very_User_centric">&#182;</a>
        </div>
        <p>Author:: Couchbase <a href="mailto:info@couchbase.com">info@couchbase.com</a>
Copyright:: 2012 Couchbase, Inc.
License:: Apache License, Version 2.0</p>

<p>Licensed under the Apache License, Version 2.0 (the &ldquo;License&rdquo;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &ldquo;AS IS&rdquo; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>

<h2>The User class contains all the actions that users take on the system, very User centric</h2>

<h2>Note: for the document keys starting with num_ we employed metaprogramming to create methods</h2>

<h2>for get and increment, see create<em>doc</em>keys() to see how that was done, we did this because there were</h2>

<h2>so many keys to keep the file size small and reduce typing errors</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">RadlibsBase</span>
  <span class="kp">include</span> <span class="no">DocumentStore</span>
  <span class="kp">include</span> <span class="no">ModelValidations</span>
  <span class="kp">include</span> <span class="no">ModelGlobal</span>
  <span class="kp">include</span> <span class="no">ErrorCodes</span>

  <span class="kp">attr_accessor</span> <span class="ss">:uid</span><span class="p">,</span> <span class="ss">:firstname</span><span class="p">,</span> <span class="ss">:lastname</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:nickname</span><span class="p">,</span> <span class="ss">:gender</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:facebook_id</span><span class="p">,</span>
                <span class="ss">:fb_img_square</span><span class="p">,</span> <span class="ss">:fb_img_small</span><span class="p">,</span> <span class="ss">:fb_img_normal</span><span class="p">,</span> <span class="ss">:fb_img_large</span><span class="p">,</span> <span class="ss">:fb_friends</span><span class="p">,</span>
                <span class="ss">:fb_access_token</span><span class="p">,</span> <span class="ss">:fb_token_expires</span><span class="p">,</span> <span class="ss">:super_user</span>


  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="kp">attr</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@super_user</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="kp">attr</span> <span class="o">=</span> <span class="no">Map</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="kp">attr</span><span class="p">)</span>
    <span class="k">super</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>load passed in parameter attributes</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">load_parameter_attributes</span> <span class="kp">attr</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Typically in Couchbase you want to create document and then modify instead of waiting for save method at the end
we pass in :create =&gt; true to create this user, then we can modify the user later
We&rsquo;ll make sure it&rsquo;s valid by checking to see if the user already exists</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="kp">attr</span><span class="o">.</span><span class="n">has_key_and_value?</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span>
      <span class="k">raise</span> <span class="s2">&quot;trying to create user -- user exists already (via facebook_id)&quot;</span> <span class="k">if</span> <span class="vi">@facebook_id</span> <span class="o">&amp;&amp;</span> <span class="no">User</span><span class="o">.</span><span class="n">find_user_by_facebook_id</span><span class="p">(</span><span class="vi">@facebook_id</span><span class="p">)</span>
      <span class="k">raise</span> <span class="s2">&quot;trying to create user -- user exists already (via email)&quot;</span> <span class="k">if</span> <span class="vi">@email</span> <span class="o">&amp;&amp;</span> <span class="no">User</span><span class="o">.</span><span class="n">find_user_by_email</span><span class="p">(</span><span class="vi">@email</span><span class="p">)</span>
      <span class="k">raise</span> <span class="s2">&quot;trying to create user -- user exists already (via uid)&quot;</span> <span class="k">if</span> <span class="vi">@uid</span> <span class="o">&amp;&amp;</span> <span class="no">User</span><span class="o">.</span><span class="n">find_user_by_uid</span><span class="p">(</span><span class="vi">@uid</span><span class="p">)</span>
      <span class="n">create_new</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Either we are creating or retrieving a user, if we are retrieving, we need at least one of three possible user
identifiers to be passed in as an attribute/parameter</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="kp">attr</span><span class="o">.</span><span class="n">has_key_and_value?</span><span class="p">(</span><span class="ss">:retrieve</span><span class="p">)</span>
      <span class="k">unless</span> <span class="kp">attr</span><span class="o">.</span><span class="n">has_key_and_value?</span><span class="p">(</span><span class="ss">:facebook_id</span><span class="p">)</span> <span class="o">||</span> <span class="kp">attr</span><span class="o">.</span><span class="n">has_key_and_value?</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="o">||</span> <span class="kp">attr</span><span class="o">.</span><span class="n">has_key_and_value?</span><span class="p">(</span><span class="ss">:uid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="s2">&quot;trying to retrieve user -- requires facebook_id, email or uid&quot;</span>
      <span class="k">end</span>
      <span class="n">load_persisted</span>

    <span class="k">end</span>

    <span class="nb">self</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-PRIVATE/DEFAULT/OVERLOADED_METHODS'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-PRIVATE/DEFAULT/OVERLOADED_METHODS">&#182;</a>
        </div>
        <h3>PRIVATE/DEFAULT/OVERLOADED METHODS</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">create_doc_keys</span>
    <span class="k">unless</span> <span class="vi">@doc_keys_setup</span>
      <span class="vi">@docs</span> <span class="o">=</span> <span class="p">{}</span>

      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">&quot;</span>

      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:facebook_ref</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;fb::</span><span class="si">#{</span><span class="vi">@facebook_id</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:email_ref</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;email::</span><span class="si">#{</span><span class="vi">@email</span><span class="o">.</span><span class="n">downcase</span><span class="si">}</span><span class="s2">&quot;</span>

      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:radlibs_created</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::radlibs_created&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:radlibs_filled</span><span class="o">]</span>  <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::radlibs_filled&quot;</span>

      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_site_visits</span><span class="o">]</span>  <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::site_visits&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_radlibs_created</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::radlibs_created_count&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_radlibs_filled_by_me</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::radlibs_filled_by_me_count&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_radlibs_filled_by_others</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::radlibs_filled_by_others_count&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_comments_made</span><span class="o">]</span>  <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::comments_made_count&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_comments_received</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::comments_received_count&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_likes_made</span><span class="o">]</span>  <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::likes_made_count&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_likes_received</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::likes_received_count&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_radlib_views_made</span><span class="o">]</span>  <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::views_made_count&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_radlib_views_received</span><span class="o">]</span>  <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::views_received_count&quot;</span>

      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:facebook_friends</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::facebook_friends&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_facebook_friends</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;u::</span><span class="si">#{</span><span class="n">uid</span><span class="si">}</span><span class="s2">::num_facebook_friends&quot;</span>

      <span class="vi">@doc_keys_setup</span> <span class="o">=</span> <span class="kp">true</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Since we have a lot of stats keys, use some metaprogramming to define the methods for get and increment</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="vi">@docs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">method</span><span class="p">,</span><span class="n">v</span><span class="o">|</span>

        <span class="k">if</span> <span class="nb">method</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">starts_with?</span><span class="p">(</span><span class="s2">&quot;num_&quot;</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>create get method for document symbol that starts with num_
i.e. def num<em>site</em>views</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:define_method</span><span class="p">,</span> <span class="nb">method</span><span class="p">)</span> <span class="k">do</span>
            <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="nb">method</span><span class="o">]</span><span class="p">)</span>
          <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>create increment method for document symbol that starts with num_
i.e. def increment<em>site</em>views</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:define_method</span><span class="p">,</span> <span class="nb">method</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="s2">&quot;increment&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_sym</span><span class="p">)</span> <span class="k">do</span>
            <span class="n">increase_atomic_count</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="nb">method</span><span class="o">]</span><span class="p">)</span>
          <span class="k">end</span>


        <span class="k">end</span>
      <span class="k">end</span>


    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create_default_docs</span>
    <span class="n">create_doc_keys</span> <span class="k">unless</span> <span class="n">doc_keys_setup</span>

    <span class="k">if</span> <span class="vi">@uid</span> <span class="o">&amp;&amp;</span> <span class="vi">@facebook_id</span>

      <span class="n">default_user_doc</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                           <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="vi">@uid</span><span class="p">,</span>
                           <span class="ss">:firstname</span> <span class="o">=&gt;</span> <span class="vi">@firstname</span><span class="p">,</span>
                           <span class="ss">:lastname</span> <span class="o">=&gt;</span> <span class="vi">@lastname</span><span class="p">,</span>
                           <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="vi">@name</span><span class="p">,</span>
                           <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="vi">@email</span><span class="p">,</span>
                           <span class="ss">:facebook_id</span> <span class="o">=&gt;</span> <span class="vi">@facebook_id</span><span class="p">,</span>
                           <span class="ss">:nickname</span> <span class="o">=&gt;</span> <span class="vi">@nickname</span><span class="p">,</span>
                           <span class="ss">:gender</span> <span class="o">=&gt;</span> <span class="vi">@gender</span><span class="p">,</span>
                           <span class="ss">:fb_img_square</span> <span class="o">=&gt;</span> <span class="vi">@fb_img_square</span><span class="p">,</span>
                           <span class="ss">:fb_img_small</span> <span class="o">=&gt;</span> <span class="vi">@fb_img_small</span><span class="p">,</span>
                           <span class="ss">:fb_img_normal</span> <span class="o">=&gt;</span> <span class="vi">@fb_img_normal</span><span class="p">,</span>
                           <span class="ss">:fb_img_large</span> <span class="o">=&gt;</span> <span class="vi">@fb_img_large</span><span class="p">,</span>
                           <span class="ss">:fb_access_token</span> <span class="o">=&gt;</span> <span class="vi">@fb_access_token</span><span class="p">,</span>
                           <span class="ss">:fb_token_expires</span> <span class="o">=&gt;</span> <span class="n">fb_token_expires</span><span class="p">,</span>
                           <span class="ss">:super_user</span> <span class="o">=&gt;</span> <span class="vi">@super_user</span><span class="p">}</span>

      <span class="n">initialize_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">,</span> <span class="n">default_user_doc</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>initialize if we have a facebookID and userID, simple for now</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">initialize_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:facebook_ref</span><span class="o">]</span><span class="p">,</span> <span class="vi">@uid</span><span class="p">)</span>
      <span class="n">initialize_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:email_ref</span><span class="o">]</span><span class="p">,</span> <span class="vi">@uid</span><span class="p">)</span>

      <span class="n">default_radlibs_arrays</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:radlibs</span> <span class="o">=&gt;</span> <span class="o">[]</span> <span class="p">}</span>
      <span class="n">initialize_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:radlibs_created</span><span class="o">]</span><span class="p">,</span> <span class="n">default_radlibs_arrays</span><span class="p">)</span>
      <span class="n">initialize_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:radlibs_filled</span><span class="o">]</span><span class="p">,</span> <span class="n">default_radlibs_arrays</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-STATS,_initialize_all_docs_that_start_with_num__with_a_count_of_0'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-STATS,_initialize_all_docs_that_start_with_num__with_a_count_of_0">&#182;</a>
        </div>
        <h2>STATS, initialize all docs that start with num_ with a count of 0</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="vi">@docs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">doc_key</span><span class="p">,</span><span class="n">v</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">doc_key</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">starts_with?</span><span class="p">(</span><span class="s2">&quot;num_&quot;</span><span class="p">)</span>
          <span class="n">initialize_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="n">doc_key</span><span class="o">]</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">initialize_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:facebook_friends</span><span class="o">]</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:friends</span> <span class="o">=&gt;</span> <span class="o">[]</span> <span class="p">})</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>create a new user and associated documents</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">create_new</span>
    <span class="vi">@uid</span> <span class="o">=</span> <span class="n">get_new_uid</span>
    <span class="n">create_default_docs</span>
    <span class="k">if</span> <span class="vi">@super_user</span>
      <span class="n">add_super_user</span><span class="p">(</span><span class="vi">@uid</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">load_persisted</span>
    <span class="k">if</span> <span class="vi">@facebook_id</span>
      <span class="vi">@uid</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;fb::</span><span class="si">#{</span><span class="vi">@facebook_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="vi">@email</span>
      <span class="vi">@uid</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;email::</span><span class="si">#{</span><span class="vi">@email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">load_parameter_attributes</span> <span class="n">get_document</span><span class="p">(</span><span class="s2">&quot;u::</span><span class="si">#{</span><span class="vi">@uid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">create_default_docs</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-PROPERTIES_&amp;amp;_PROPERTY_OVERLOADS'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-PROPERTIES_&amp;amp;_PROPERTY_OVERLOADS">&#182;</a>
        </div>
        <h3>PROPERTIES &amp; PROPERTY OVERLOADS</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kp">public</span>

  <span class="k">def</span> <span class="nf">radlibs_created</span><span class="p">(</span><span class="n">get_radlib_objects</span> <span class="o">=</span> <span class="kp">false</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">get_radlib_objects</span>

      <span class="n">doc</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:radlibs_created</span><span class="o">]</span><span class="p">)</span>
      <span class="n">create_default_docs</span> <span class="k">unless</span> <span class="n">doc</span>

      <span class="n">radlibs</span> <span class="o">=</span> <span class="o">[]</span>

      <span class="n">doc</span><span class="o">[</span><span class="ss">:radlibs</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
        <span class="n">radlib</span> <span class="o">=</span> <span class="n">find_radlib_by_radlib_id</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">radlibs</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">radlib</span><span class="p">)</span> <span class="k">if</span> <span class="n">radlib</span>
      <span class="k">end</span>

      <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">radlibs</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">radlibs</span>

    <span class="k">else</span>
      <span class="n">doc</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:radlibs_created</span><span class="o">]</span><span class="p">)</span>
      <span class="n">create_default_docs</span> <span class="k">unless</span> <span class="n">doc</span>
      <span class="n">doc</span><span class="o">[</span><span class="ss">:radlibs</span><span class="o">]</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">radlibs_filled</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:radlibs_filled</span><span class="o">]</span><span class="p">)</span>
    <span class="n">create_default_docs</span> <span class="k">unless</span> <span class="n">doc</span>
    <span class="n">doc</span><span class="o">[</span><span class="ss">:radlibs</span><span class="o">]</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-STATS_Reporting_&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-STATS_Reporting_&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;">&#182;</a>
        </div>
        <h2>STATS Reporting &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-REPLACED_BY_METAPROGRAMMING,_see_create&lt;em&gt;doc&lt;/em&gt;keys()'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-REPLACED_BY_METAPROGRAMMING,_see_create&lt;em&gt;doc&lt;/em&gt;keys()">&#182;</a>
        </div>
        <h2>REPLACED BY METAPROGRAMMING, see create<em>doc</em>keys()</h2>

<p>def radlibs<em>filled</em>by<em>me
 atomic</em>count = get<em>document(@docs[:num</em>radlibs<em>filled</em>by<em>me])
 create</em>default<em>docs unless atomic</em>count
 atomic_count
end</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-STATS_Tracking_&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-STATS_Tracking_&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;">&#182;</a>
        </div>
        <h2>STATS Tracking &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-REPLACED_BY_METAPROGRAMMING,_see_create&lt;em&gt;doc&lt;/em&gt;keys()'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-REPLACED_BY_METAPROGRAMMING,_see_create&lt;em&gt;doc&lt;/em&gt;keys()">&#182;</a>
        </div>
        <h2>REPLACED BY METAPROGRAMMING, see create<em>doc</em>keys()</h2>

<p>def increment<em>radlibs</em>filled<em>by</em>me
 atomic<em>count = get</em>document(@docs[:num<em>radlibs</em>filled<em>by</em>me])
 create<em>default</em>docs unless atomic<em>count
 increase</em>atomic<em>count(@docs[:num</em>radlibs<em>filled</em>by_me])
end</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">is_super_user?</span>
    <span class="vi">@super_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">is_superuser?</span>
    <span class="vi">@super_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">facebook_friends</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:facebook_friends</span><span class="o">]</span><span class="p">)</span>
    <span class="n">doc</span><span class="o">[</span><span class="ss">:friends</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">facebook_friends</span><span class="o">=</span><span class="p">(</span><span class="n">friend_hash</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:facebook_friends</span><span class="o">]</span><span class="p">)</span>

    <span class="no">Analytics</span><span class="o">.</span><span class="n">decrement_facebook_friends</span><span class="p">(</span><span class="n">doc</span><span class="o">[</span><span class="ss">:friends</span><span class="o">].</span><span class="n">size</span><span class="p">)</span>

    <span class="n">doc</span><span class="o">[</span><span class="ss">:friends</span><span class="o">]</span> <span class="o">=</span> <span class="n">friend_hash</span>

    <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">doc</span><span class="o">[</span><span class="ss">:friends</span><span class="o">].</span><span class="n">size</span><span class="p">)</span>
    <span class="no">Analytics</span><span class="o">.</span><span class="n">increment_facebook_friends</span><span class="p">(</span><span class="n">doc</span><span class="o">[</span><span class="ss">:friends</span><span class="o">].</span><span class="n">size</span><span class="p">)</span>

    <span class="n">replace_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:facebook_friends</span><span class="o">]</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
    <span class="n">force_set_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_facebook_friends</span><span class="o">]</span><span class="p">,</span> <span class="n">doc</span><span class="o">[</span><span class="ss">:friends</span><span class="o">].</span><span class="n">size</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-USER_ACTIONS_&amp;ndash;_the_things_the_User_can_DO'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-USER_ACTIONS_&amp;ndash;_the_things_the_User_can_DO">&#182;</a>
        </div>
        <h3>USER ACTIONS &ndash; the things the User can DO</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">action_create_new_radlib</span><span class="p">(</span><span class="n">radlib_title</span><span class="p">,</span> <span class="n">radlib_text_array</span><span class="p">,</span> <span class="n">original_sentences</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">validate_create_new_radlib</span><span class="p">(</span><span class="n">radlib_title</span><span class="p">,</span> <span class="n">radlib_text_array</span><span class="p">)</span>

      <span class="n">new_radlib</span> <span class="o">=</span> <span class="no">RadlibStory</span><span class="o">.</span><span class="n">new</span> <span class="p">({</span> <span class="ss">:create</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                                      <span class="ss">:radlib_title</span> <span class="o">=&gt;</span> <span class="n">radlib_title</span><span class="p">,</span>
                                      <span class="ss">:radlib_text_array</span> <span class="o">=&gt;</span> <span class="n">radlib_text_array</span><span class="p">,</span>
                                      <span class="ss">:author_uid</span> <span class="o">=&gt;</span> <span class="vi">@uid</span><span class="p">,</span>
                                      <span class="ss">:original_sentences</span> <span class="o">=&gt;</span> <span class="n">original_sentences</span><span class="p">})</span>

      <span class="n">add_radlib_to_created</span><span class="p">(</span><span class="n">new_radlib</span><span class="o">.</span><span class="n">radlib_id</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Run Analytics on new data</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="no">Analytics</span><span class="o">.</span><span class="n">analyze_user</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

      <span class="n">result</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:success</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                 <span class="ss">:radlib_id</span> <span class="o">=&gt;</span> <span class="n">new_radlib</span><span class="o">.</span><span class="n">radlib_id</span><span class="p">,</span>
                 <span class="ss">:radlib_url</span> <span class="o">=&gt;</span> <span class="no">Yetting</span><span class="o">.</span><span class="n">domain</span> <span class="o">+</span> <span class="s2">&quot;r/</span><span class="si">#{</span><span class="n">new_radlib</span><span class="o">.</span><span class="n">radlib_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                 <span class="ss">:error_name</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
                 <span class="ss">:error_code</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
                 <span class="ss">:reason</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
                 <span class="ss">:help_text</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
                 <span class="ss">:backtrace</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">}</span>
    <span class="k">end</span>

  <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="k">raise</span> <span class="n">e</span> <span class="k">unless</span> <span class="no">RADLIB_CREATE_ERRORS</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">:success</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
        <span class="ss">:radlib_id</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
        <span class="ss">:radlib_url</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
        <span class="ss">:error_name</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span>
        <span class="ss">:error_code</span> <span class="o">=&gt;</span> <span class="no">ErrorCodes</span><span class="o">::</span><span class="no">RADLIB_CREATE_ERRORS</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:reason</span> <span class="o">=&gt;</span> <span class="no">ErrorCodes</span><span class="o">::</span><span class="no">RADLIB_CREATE_ERRORS</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="o">][</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:help_text</span> <span class="o">=&gt;</span> <span class="no">ErrorCodes</span><span class="o">::</span><span class="no">RADLIB_CREATE_ERRORS</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="o">][</span><span class="mi">2</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:backtrace</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span><span class="o">.</span><span class="n">inspect</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">action_fill_in_radlib</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">,</span> <span class="n">radlib_text_array</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">validate_fill_in_radlib</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">,</span> <span class="n">radlib_text_array</span><span class="p">)</span>
      <span class="n">radlib</span> <span class="o">=</span> <span class="n">find_radlib_by_radlib_id</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">)</span>
      <span class="n">radlib_fillin</span> <span class="o">=</span> <span class="n">radlib</span><span class="o">.</span><span class="n">add_fillin</span><span class="p">({</span><span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="vi">@uid</span><span class="p">,</span> <span class="ss">:radlib_text_array</span> <span class="o">=&gt;</span> <span class="n">radlib_text_array</span><span class="p">})</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>increase num<em>radlibs</em>filled</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">increment_radlibs_filled_by_me</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>get the author, and increase num<em>radlibs</em>filled<em>by</em>others</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">author</span> <span class="o">=</span> <span class="n">find_user_by_uid</span><span class="p">(</span><span class="n">radlib</span><span class="o">.</span><span class="n">author_uid</span><span class="p">)</span>
      <span class="n">author</span><span class="o">.</span><span class="n">increment_radlibs_filled_by_others</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Run Analytics on new data</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="no">Analytics</span><span class="o">.</span><span class="n">analyze_user</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
      <span class="no">Analytics</span><span class="o">.</span><span class="n">analyze_user</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>

      <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
          <span class="ss">:success</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
          <span class="ss">:radlib_id</span> <span class="o">=&gt;</span> <span class="n">radlib_id</span><span class="p">,</span>
          <span class="ss">:radlib_fillin_id</span> <span class="o">=&gt;</span> <span class="n">radlib_fillin</span><span class="o">.</span><span class="n">radlib_fillin_id</span><span class="p">,</span>
          <span class="ss">:radlib_url</span> <span class="o">=&gt;</span> <span class="no">Yetting</span><span class="o">.</span><span class="n">domain</span> <span class="o">+</span> <span class="s2">&quot;r/</span><span class="si">#{</span><span class="n">radlib_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
          <span class="ss">:error_name</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
          <span class="ss">:error_code</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
          <span class="ss">:reason</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
          <span class="ss">:help_text</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
          <span class="ss">:backtrace</span> <span class="o">=&gt;</span> <span class="kp">nil</span>
      <span class="p">}</span>
    <span class="k">end</span>

  <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="k">raise</span> <span class="n">e</span> <span class="k">unless</span> <span class="no">RADLIB_FILLIN_ERRORS</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">:success</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
        <span class="ss">:radlib_id</span> <span class="o">=&gt;</span> <span class="n">radlib_id</span><span class="p">,</span>
        <span class="ss">:radlib_fillin_id</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
        <span class="ss">:radlib_url</span> <span class="o">=&gt;</span> <span class="no">Yetting</span><span class="o">.</span><span class="n">domain</span> <span class="o">+</span> <span class="s2">&quot;r/</span><span class="si">#{</span><span class="n">radlib_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="ss">:error_name</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span>
        <span class="ss">:error_code</span> <span class="o">=&gt;</span> <span class="no">ErrorCodes</span><span class="o">::</span><span class="no">RADLIB_FILLIN_ERRORS</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:reason</span> <span class="o">=&gt;</span> <span class="no">ErrorCodes</span><span class="o">::</span><span class="no">RADLIB_FILLIN_ERRORS</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="o">][</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:help_text</span> <span class="o">=&gt;</span> <span class="no">ErrorCodes</span><span class="o">::</span><span class="no">RADLIB_FILLIN_ERRORS</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="o">][</span><span class="mi">2</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:backtrace</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span><span class="o">.</span><span class="n">inspect</span>
    <span class="p">}</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>Validates the like<em>radlib</em>fillin
if valid
  Adds a like to the radlib itself (if not already counted, via RadlibStory Class)
    Adds a likes<em>received to author of radlib (if not already counted)
    Runs Analytics on RadlibStory and Radlib Author (if new data, handled by RadlibStory Class)
  Adds a like to the radlib fillin (if not already counted)
  Adds a likes</em>made to user who liked (if not already counted)
  if like was new
    Runs Analytics on User who liked
returns result Hash</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">action_like_radlib_fillin</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">,</span> <span class="n">radlib_fillin_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">validate_like_fillin</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">,</span> <span class="n">radlib_fillin_id</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>do this for the radlib itself to track total likes, this will also increase it for the radlib author</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">radlib</span> <span class="o">=</span> <span class="n">find_radlib_by_radlib_id</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>add a like to the radlib itself (it checks if it&rsquo;s already been counted),
also handles adding likes_received for the radlib author, and Analytics for Radlib and Author</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">radlib</span><span class="o">.</span><span class="n">add_like</span><span class="p">(</span><span class="vi">@uid</span><span class="p">)</span>

      <span class="n">radlib_fillin</span> <span class="o">=</span> <span class="no">RadlibFillin</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="ss">:retrieve</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:radlib_fillin_id</span> <span class="o">=&gt;</span> <span class="n">radlib_fillin_id</span><span class="p">})</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>get current likes</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">new_likes_count</span> <span class="o">=</span> <span class="n">radlib_fillin</span><span class="o">.</span><span class="n">num_likes</span>

      <span class="k">if</span> <span class="n">radlib_fillin</span><span class="o">.</span><span class="n">add_like</span><span class="p">(</span><span class="vi">@uid</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>increase by one since it was a success</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">new_likes_count</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>add one to the count of likes User has made</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">increment_likes_made</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>Run Analytics on new data</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="no">Analytics</span><span class="o">.</span><span class="n">analyze_user</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
          <span class="ss">:success</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
          <span class="ss">:radlib_id</span> <span class="o">=&gt;</span> <span class="n">radlib_id</span><span class="p">,</span>
          <span class="ss">:radlib_fillin_id</span> <span class="o">=&gt;</span> <span class="n">radlib_fillin_id</span><span class="p">,</span>
          <span class="ss">:radlib_url</span> <span class="o">=&gt;</span> <span class="no">Yetting</span><span class="o">.</span><span class="n">domain</span> <span class="o">+</span> <span class="s2">&quot;r/</span><span class="si">#{</span><span class="n">radlib_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
          <span class="ss">:likes_count</span> <span class="o">=&gt;</span> <span class="n">new_likes_count</span><span class="p">,</span>
          <span class="ss">:total_radlib_likes</span> <span class="o">=&gt;</span> <span class="n">radlib</span><span class="o">.</span><span class="n">num_likes</span><span class="p">,</span>
          <span class="ss">:error_name</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
          <span class="ss">:error_code</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
          <span class="ss">:reason</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
          <span class="ss">:help_text</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
          <span class="ss">:backtrace</span> <span class="o">=&gt;</span> <span class="kp">nil</span>
      <span class="p">}</span>
    <span class="k">end</span>

  <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="k">raise</span> <span class="n">e</span> <span class="k">unless</span> <span class="no">RADLIB_LIKE_FILLIN_ERRORS</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">:success</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
        <span class="ss">:radlib_id</span> <span class="o">=&gt;</span> <span class="n">radlib_id</span><span class="p">,</span>
        <span class="ss">:radlib_fillin_id</span> <span class="o">=&gt;</span> <span class="n">radlib_fillin_id</span><span class="p">,</span>
        <span class="ss">:radlib_url</span> <span class="o">=&gt;</span> <span class="no">Yetting</span><span class="o">.</span><span class="n">domain</span> <span class="o">+</span> <span class="s2">&quot;r/</span><span class="si">#{</span><span class="n">radlib_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="ss">:error_name</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span>
        <span class="ss">:error_code</span> <span class="o">=&gt;</span> <span class="no">ErrorCodes</span><span class="o">::</span><span class="no">RADLIB_LIKE_FILLIN_ERRORS</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:reason</span> <span class="o">=&gt;</span> <span class="no">ErrorCodes</span><span class="o">::</span><span class="no">RADLIB_LIKE_FILLIN_ERRORS</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="o">][</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:help_text</span> <span class="o">=&gt;</span> <span class="no">ErrorCodes</span><span class="o">::</span><span class="no">RADLIB_LIKE_FILLIN_ERRORS</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="o">][</span><span class="mi">2</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:backtrace</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span><span class="o">.</span><span class="n">inspect</span>
    <span class="p">}</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">action_comment_on_fillin</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">,</span> <span class="n">radlib_fillin_id</span><span class="p">,</span> <span class="n">comment_text</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">validate_like_fillin</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">,</span> <span class="n">radlib_fillin_id</span><span class="p">)</span>
      <span class="n">radlib_fillin</span> <span class="o">=</span> <span class="no">RadlibFillin</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="ss">:retrieve</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:radlib_fillin_id</span> <span class="o">=&gt;</span> <span class="n">radlib_fillin_id</span><span class="p">})</span>
      <span class="n">comment_index</span> <span class="o">=</span> <span class="n">radlib_fillin</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="vi">@uid</span><span class="p">,</span> <span class="n">comment_text</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>increment the count for comments made</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">increment_comments_made</span>

      <span class="no">Analytics</span><span class="o">.</span><span class="n">analyze_user</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

      <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">intense_red</span><span class="p">(</span><span class="n">comment_index</span><span class="p">))</span>
      <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
          <span class="ss">:success</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
          <span class="ss">:radlib_id</span> <span class="o">=&gt;</span> <span class="n">radlib_id</span><span class="p">,</span>
          <span class="ss">:radlib_fillin_id</span> <span class="o">=&gt;</span> <span class="n">radlib_fillin_id</span><span class="p">,</span>
          <span class="ss">:comment_count</span> <span class="o">=&gt;</span> <span class="n">comment_index</span><span class="p">,</span>
          <span class="ss">:author_name</span> <span class="o">=&gt;</span> <span class="vi">@firstname</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="vi">@lastname</span><span class="p">,</span>
          <span class="ss">:author_profile_img</span> <span class="o">=&gt;</span> <span class="vi">@fb_img_square</span><span class="p">,</span>
          <span class="ss">:comment_text</span> <span class="o">=&gt;</span> <span class="n">radlib_fillin</span><span class="o">[</span><span class="n">comment_index</span><span class="o">][</span><span class="ss">:text</span><span class="o">]</span><span class="p">,</span>
          <span class="ss">:timestamp</span> <span class="o">=&gt;</span> <span class="n">radlib_fillin</span><span class="o">[</span><span class="n">comment_index</span><span class="o">][</span><span class="ss">:timestamp</span><span class="o">]</span><span class="p">,</span>
          <span class="ss">:error_name</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
          <span class="ss">:error_code</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
          <span class="ss">:reason</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
          <span class="ss">:help_text</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
          <span class="ss">:backtrace</span> <span class="o">=&gt;</span> <span class="kp">nil</span>
      <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="k">raise</span> <span class="n">e</span> <span class="k">unless</span> <span class="no">RADLIB_COMMENT_FILLIN_ERRORS</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">:success</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
        <span class="ss">:radlib_id</span> <span class="o">=&gt;</span> <span class="n">radlib_id</span><span class="p">,</span>
        <span class="ss">:radlib_fillin_id</span> <span class="o">=&gt;</span> <span class="n">radlib_fillin_id</span><span class="p">,</span>
        <span class="ss">:radlib_url</span> <span class="o">=&gt;</span> <span class="no">Yetting</span><span class="o">.</span><span class="n">domain</span> <span class="o">+</span> <span class="s2">&quot;r/</span><span class="si">#{</span><span class="n">radlib_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="ss">:error_name</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span>
        <span class="ss">:error_code</span> <span class="o">=&gt;</span> <span class="no">ErrorCodes</span><span class="o">::</span><span class="no">RADLIB_COMMENT_FILLIN_ERRORS</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:reason</span> <span class="o">=&gt;</span> <span class="no">ErrorCodes</span><span class="o">::</span><span class="no">RADLIB_COMMENT_FILLIN_ERRORS</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="o">][</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:help_text</span> <span class="o">=&gt;</span> <span class="no">ErrorCodes</span><span class="o">::</span><span class="no">RADLIB_COMMENT_FILLIN_ERRORS</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">to_sym</span><span class="o">][</span><span class="mi">2</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:backtrace</span> <span class="o">=&gt;</span> <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span><span class="o">.</span><span class="n">inspect</span>
    <span class="p">}</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-PUBLIC_METHODS'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-PUBLIC_METHODS">&#182;</a>
        </div>
        <h3>PUBLIC METHODS</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kp">public</span>

  <span class="k">def</span> <span class="nf">add_radlib_to_created</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:radlibs_created</span><span class="o">]</span><span class="p">)</span>
    <span class="n">create_default_docs</span> <span class="k">unless</span> <span class="n">doc</span>

    <span class="n">radlibs</span> <span class="o">=</span> <span class="n">doc</span><span class="o">[</span><span class="ss">:radlibs</span><span class="o">]</span>
    <span class="n">radlibs</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">)</span>
    <span class="n">doc</span><span class="o">[</span><span class="ss">:radlibs</span><span class="o">]</span> <span class="o">=</span> <span class="n">radlibs</span>

    <span class="n">atomic_count</span> <span class="o">=</span> <span class="n">increase_atomic_count</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_radlibs_created</span><span class="o">]</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">radlibs</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">atomic_count</span>
      <span class="n">replace_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_radlibs_created</span><span class="o">]</span><span class="p">,</span> <span class="n">radlibs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">replace_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:radlibs_created</span><span class="o">]</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">add_radlib_filled</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:radlibs_filled</span><span class="o">]</span><span class="p">)</span>
    <span class="n">create_default_docs</span> <span class="k">unless</span> <span class="n">doc</span>

    <span class="n">radlibs</span> <span class="o">=</span> <span class="n">doc</span><span class="o">[</span><span class="ss">:radlibs</span><span class="o">]</span>
    <span class="n">radlibs</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">)</span>
    <span class="n">doc</span><span class="o">[</span><span class="ss">:radlibs</span><span class="o">]</span> <span class="o">=</span> <span class="n">radlibs</span>

    <span class="n">atomic_count</span> <span class="o">=</span> <span class="n">increase_atomic_count</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:radlibs_filled_count</span><span class="o">]</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">radlibs</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">atomic_count</span>
      <span class="n">replace_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:radlibs_filled_count</span><span class="o">]</span><span class="p">,</span> <span class="n">radlibs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">replace_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:radlibs_filled</span><span class="o">]</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-CLASS_METHODS'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-CLASS_METHODS">&#182;</a>
        </div>
        <h3>CLASS METHODS</h3>

      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">add_radlib_to_created</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">radlib_id</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_user_by_uid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">add_radlib_to_created</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">add_radlib_to_filled</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">radlib_id</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_user_by_uid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">add_radlib_filled</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">add_total_like</span>
    <span class="n">atomic_count</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_likes_received</span><span class="o">]</span><span class="p">)</span>
    <span class="n">create_default_docs</span> <span class="k">unless</span> <span class="n">atomic_count</span>
    <span class="n">increase_atomic_count</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_likes_received</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
