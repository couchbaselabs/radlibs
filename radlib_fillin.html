<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>radlib_fillin.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="analytics.html">analytics.rb</a>
          <a class="source" href="document_store.html">document_store.rb</a>
          <a class="source" href="error_codes.html">error_codes.rb</a>
          <a class="source" href="model_global.html">model_global.rb</a>
          <a class="source" href="model_validations.html">model_validations.rb</a>
          <a class="source" href="radlib_fillin.html">radlib_fillin.rb</a>
          <a class="source" href="radlib_fillin_collection.html">radlib_fillin_collection.rb</a>
          <a class="source" href="radlib_story.html">radlib_story.rb</a>
          <a class="source" href="radlib_text_array.html">radlib_text_array.rb</a>
          <a class="source" href="radlibs_base.html">radlibs_base.rb</a>
          <a class="source" href="user.html">user.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>radlib_fillin.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-RadlibStory_handles_the_fillin&lt;em&gt;index,_and_passes_it_to_RadlibFillin,_see_RadlibStory#add&lt;/em&gt;fillin'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-RadlibStory_handles_the_fillin&lt;em&gt;index,_and_passes_it_to_RadlibFillin,_see_RadlibStory#add&lt;/em&gt;fillin">&#182;</a>
        </div>
        <p>Author:: Couchbase <a href="mailto:info@couchbase.com">info@couchbase.com</a>
Copyright:: 2012 Couchbase, Inc.
License:: Apache License, Version 2.0</p>

<p>Licensed under the Apache License, Version 2.0 (the &ldquo;License&rdquo;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &ldquo;AS IS&rdquo; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>

<h1>RadlibStory handles the fillin<em>index, and passes it to RadlibFillin, see RadlibStory#add</em>fillin</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">RadlibFillin</span> <span class="o">&lt;</span> <span class="no">RadlibsBase</span>
  <span class="kp">include</span> <span class="no">DocumentStore</span>
  <span class="kp">include</span> <span class="no">ModelValidations</span>
  <span class="kp">include</span> <span class="no">ModelGlobal</span>
  <span class="kp">include</span> <span class="no">ErrorCodes</span>
  <span class="kp">extend</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Callbacks</span>
  <span class="kp">extend</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Naming</span>
  
  <span class="kp">attr_accessor</span> <span class="ss">:radlib_id</span><span class="p">,</span> <span class="ss">:radlib_fillin_id</span><span class="p">,</span> <span class="ss">:fillin_index</span><span class="p">,</span> <span class="ss">:uid</span><span class="p">,</span> <span class="ss">:user_inputs</span>
  
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="kp">attr</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="kp">attr</span> <span class="o">=</span> <span class="no">Map</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="kp">attr</span><span class="p">)</span>
    <span class="k">super</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>load passed in parameter attributes</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">load_parameter_attributes</span> <span class="kp">attr</span>

    <span class="k">if</span> <span class="kp">attr</span><span class="o">.</span><span class="n">has_key_and_value?</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span>
      <span class="k">if</span> <span class="kp">attr</span><span class="o">.</span><span class="n">has_key_and_value?</span><span class="p">(</span><span class="ss">:radlib_fillin_id</span><span class="p">)</span>
        <span class="n">parse_radlib_fillin_id</span><span class="p">(</span><span class="kp">attr</span><span class="o">[</span><span class="ss">:radlib_fillin_id</span><span class="o">]</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="k">raise</span> <span class="s2">&quot;trying to create radlib_fillin -- requires radlib_id and radlib must exist, and must have fillin_index &gt; 0&quot;</span> <span class="k">unless</span> <span class="vi">@radlib_id</span> <span class="o">&amp;&amp;</span> <span class="no">RadlibFillin</span><span class="o">.</span><span class="n">find_radlib_by_radlib_id</span><span class="p">(</span><span class="vi">@radlib_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="vi">@fillin_index</span> <span class="o">&amp;&amp;</span> <span class="vi">@fillin_index</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">raise</span> <span class="s2">&quot;trying to create radlib_fillin -- requires uid and user must exist&quot;</span> <span class="k">unless</span> <span class="vi">@uid</span> <span class="o">&amp;&amp;</span> <span class="no">RadlibFillin</span><span class="o">.</span><span class="n">find_user_by_uid</span><span class="p">(</span><span class="vi">@uid</span><span class="p">)</span>
      <span class="k">raise</span> <span class="s2">&quot;trying to create radlib_fillin -- requires user_inputs&quot;</span> <span class="k">unless</span> <span class="vi">@user_inputs</span>
      <span class="n">create_new</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Either we have at least radlib<em>id and fillin</em>index, or we have radlib<em>fillin</em>id</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="kp">attr</span><span class="o">.</span><span class="n">has_key_and_value?</span><span class="p">(</span><span class="ss">:retrieve</span><span class="p">)</span>
      <span class="k">if</span> <span class="kp">attr</span><span class="o">.</span><span class="n">has_key_and_value?</span><span class="p">(</span><span class="ss">:radlib_fillin_id</span><span class="p">)</span>
        <span class="n">parse_radlib_fillin_id</span><span class="p">(</span><span class="kp">attr</span><span class="o">[</span><span class="ss">:radlib_fillin_id</span><span class="o">]</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="k">unless</span> <span class="kp">attr</span><span class="o">.</span><span class="n">has_key_and_value?</span><span class="p">(</span><span class="ss">:radlib_fillin_id</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="kp">attr</span><span class="o">.</span><span class="n">has_key_and_value?</span><span class="p">(</span><span class="ss">:radlib_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="kp">attr</span><span class="o">.</span><span class="n">has_key_and_value?</span><span class="p">(</span><span class="ss">:fillin_index</span><span class="p">))</span>
        <span class="k">raise</span> <span class="s2">&quot;trying to retrieve radlib_fillin -- requires radlib_fillin_id or (radlib_id and fillin_index)&quot;</span>
      <span class="k">end</span>
      <span class="n">load_persisted</span>
    <span class="k">end</span>
    <span class="nb">self</span>
  <span class="k">end</span>
  
  </pre></div>
      </td>
    </tr>
    <tr id='section-PRIVATE/DEFAULT/OVERLOADED_METHODS'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-PRIVATE/DEFAULT/OVERLOADED_METHODS">&#182;</a>
        </div>
        <h3>PRIVATE/DEFAULT/OVERLOADED METHODS</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">create_doc_keys</span><span class="p">(</span><span class="n">force_reset</span> <span class="o">=</span> <span class="kp">false</span><span class="p">)</span>
    <span class="k">unless</span> <span class="vi">@doc_keys_setup</span> <span class="o">||</span> <span class="n">force_reset</span>
      <span class="vi">@docs</span> <span class="o">=</span> <span class="p">{}</span>
      
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:fillin</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;radfill::</span><span class="si">#{</span><span class="n">radlib_id</span><span class="si">}</span><span class="s2">::</span><span class="si">#{</span><span class="vi">@fillin_index</span><span class="si">}</span><span class="s2">&quot;</span>
                     
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_views</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;radfill::</span><span class="si">#{</span><span class="vi">@radlib_id</span><span class="si">}</span><span class="s2">::</span><span class="si">#{</span><span class="vi">@fillin_index</span><span class="si">}</span><span class="s2">::views&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_comments</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;radfill::</span><span class="si">#{</span><span class="vi">@radlib_id</span><span class="si">}</span><span class="s2">::</span><span class="si">#{</span><span class="vi">@fillin_index</span><span class="si">}</span><span class="s2">::comment_count&quot;</span>
      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_likes</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;radfill::</span><span class="si">#{</span><span class="vi">@radlib_id</span><span class="si">}</span><span class="s2">::</span><span class="si">#{</span><span class="vi">@fillin_index</span><span class="si">}</span><span class="s2">::likes&quot;</span>      

      <span class="vi">@docs</span><span class="o">[</span><span class="ss">:liked_by</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;radfill::</span><span class="si">#{</span><span class="vi">@radlib_id</span><span class="si">}</span><span class="s2">::</span><span class="si">#{</span><span class="vi">@fillin_index</span><span class="si">}</span><span class="s2">::liked_by&quot;</span>

      <span class="vi">@doc_keys_setup</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create_default_docs</span>
    <span class="n">create_doc_keys</span> <span class="k">unless</span> <span class="n">doc_keys_setup</span>

    <span class="n">default_doc</span> <span class="o">=</span> <span class="p">{</span> 
      <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">&quot;radlib_fillin&quot;</span><span class="p">,</span>
      <span class="ss">:radlib_fillin_id</span> <span class="o">=&gt;</span> <span class="vi">@radlib_fillin_id</span><span class="p">,</span>
      <span class="ss">:radlib_id</span> <span class="o">=&gt;</span> <span class="vi">@radlib_id</span><span class="p">,</span>
      <span class="ss">:fillin_index</span> <span class="o">=&gt;</span> <span class="vi">@fillin_index</span><span class="p">,</span>
      <span class="ss">:uid</span> <span class="o">=&gt;</span> <span class="vi">@uid</span><span class="p">,</span>
      <span class="ss">:user_inputs</span> <span class="o">=&gt;</span> <span class="vi">@user_inputs</span>
      <span class="p">}</span>
    
    <span class="n">initialize_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:fillin</span><span class="o">]</span><span class="p">,</span> <span class="n">default_doc</span><span class="p">)</span>
    
    <span class="n">initialize_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_views</span><span class="o">]</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">initialize_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_comments</span><span class="o">]</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">initialize_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_likes</span><span class="o">]</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">initialize_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:liked_by</span><span class="o">]</span><span class="p">,{</span> <span class="ss">:users</span> <span class="o">=&gt;</span> <span class="o">[]</span> <span class="p">})</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">parse_radlib_fillin_id</span><span class="p">(</span><span class="n">radlib_fillin_id</span><span class="p">)</span>
    <span class="vi">@radlib_fillin_id</span> <span class="o">=</span> <span class="n">radlib_fillin_id</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>note: make sure to be consistent with @docs[:fillin] for the matches</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="vi">@radlib_id</span> <span class="o">=</span> <span class="n">radlib_fillin_id</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;radfill::&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/[\d]+[^:]/</span><span class="p">)</span>
    <span class="vi">@fillin_index</span> <span class="o">=</span> <span class="n">radlib_fillin_id</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;radfill::&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/(::)([\d]+)/</span><span class="p">)</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>

  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>create a new user and associated documents</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">create_new</span>
    <span class="n">create_doc_keys</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
    <span class="vi">@radlib_fillin_id</span> <span class="o">=</span> <span class="vi">@docs</span><span class="o">[</span><span class="ss">:fillin</span><span class="o">]</span> <span class="k">unless</span> <span class="vi">@radlib_fillin_id</span> <span class="o">&amp;&amp;</span> <span class="vi">@radlib_fillin_id</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="c1"># if only the radlib_id and fillin_index were passed, set the @radlib_fillin_id</span>
    <span class="n">create_default_docs</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">load_persisted</span>
    <span class="n">create_doc_keys</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
    <span class="n">load_parameter_attributes</span> <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:fillin</span><span class="o">]</span><span class="p">)</span>
    <span class="n">create_default_docs</span> <span class="c1"># in case we have added some docs to this class</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-PROPERTIES_&amp;amp;_PROPERTY_OVERLOADS'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-PROPERTIES_&amp;amp;_PROPERTY_OVERLOADS">&#182;</a>
        </div>
        <h3>PROPERTIES &amp; PROPERTY OVERLOADS</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kp">public</span>
  
  <span class="k">def</span> <span class="nf">num_views</span>
    <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_views</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">num_comments</span>
    <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_comments</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">num_likes</span>
    <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_likes</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">increment_num_views</span>
    <span class="n">increase_atomic_count</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_views</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>def increment<em>num</em>likes
replaced by RadlibFillin#add_like</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">increment_num_comments</span>

  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>returns boolean on whether the &ldquo;like&rdquo; was new</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">add_like</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>get the list of users who have liked this fillin</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">doc</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:liked_by</span><span class="o">]</span><span class="p">)</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>unless this has already been liked by this person (liking_uid)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">unless</span> <span class="n">doc</span><span class="o">[</span><span class="ss">:users</span><span class="o">].</span><span class="n">include?</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>add to list</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">doc</span><span class="o">[</span><span class="ss">:users</span><span class="o">].</span><span class="n">unshift</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>store the new list</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">replace_document</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:liked_by</span><span class="o">]</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>increase the count of likes for the fillin</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">increase_atomic_count</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_likes</span><span class="o">]</span><span class="p">)</span>

      <span class="k">return</span> <span class="kp">true</span>
    <span class="k">end</span>

    <span class="kp">false</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>returns index of new comment</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">add_comment</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">comment_text</span><span class="p">)</span>

    <span class="n">radlib</span> <span class="o">=</span> <span class="n">find_radlib_by_radlib_id</span><span class="p">(</span><span class="n">radlib_id</span><span class="p">)</span>

    <span class="n">author</span> <span class="o">=</span> <span class="n">find_user_by_uid</span><span class="p">(</span><span class="n">radlib</span><span class="o">.</span><span class="n">author_uid</span><span class="p">)</span>
    <span class="n">author</span><span class="o">.</span><span class="n">increment_comments_received</span>

    <span class="n">comment_index</span> <span class="o">=</span> <span class="n">increase_atomic_count</span><span class="p">(</span><span class="vi">@docs</span><span class="o">[</span><span class="ss">:num_comments</span><span class="o">]</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">getutc</span>
    <span class="n">comment_key</span> <span class="o">=</span> <span class="n">radlib_fillin_id</span> <span class="o">+</span> <span class="s2">&quot;::comment::&quot;</span> <span class="o">+</span> <span class="n">comment_index</span><span class="o">.</span><span class="n">to_s</span>

    <span class="n">comment_doc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">&quot;radlib_fillin_comment&quot;</span><span class="p">,</span>
        <span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">uid</span><span class="p">,</span>
        <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">comment_text</span><span class="p">,</span>
        <span class="ss">:timestamp</span> <span class="o">=&gt;</span> <span class="n">timestamp</span>
    <span class="p">}</span>

    <span class="n">create_document</span><span class="p">(</span><span class="n">comment_key</span><span class="p">,</span> <span class="n">comment_doc</span><span class="p">)</span>
    <span class="n">comment_index</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>shortcut to access comments by index, also retrieves User Object</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">[]</span><span class="p">(</span><span class="n">comment_index</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@radlib_fillin_id</span> <span class="o">&amp;&amp;</span> <span class="n">comment_index</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">comment_index</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&lt;=</span> <span class="n">num_comments</span><span class="o">.</span><span class="n">to_i</span>
      <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@radlib_fillin_id</span><span class="si">}</span><span class="s2">::comment::</span><span class="si">#{</span><span class="n">comment_index</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="n">doc</span> <span class="o">=</span> <span class="n">get_document</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
      <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">inspect</span><span class="p">)</span>
      <span class="n">doc</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span> <span class="o">=</span> <span class="n">find_user_by_uid</span><span class="p">(</span><span class="n">doc</span><span class="o">[</span><span class="ss">:author</span><span class="o">]</span><span class="p">)</span>
      <span class="n">doc</span>
    <span class="k">else</span>
      <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
